---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.16.2
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

# Fermi edge fitting example
### In this example, we fit a linear dispersion to one of the graphene bands.

```{python}
# %load_ext autoreload
# %autoreload 2

import xarpes
import matplotlib.pyplot as plt

xarpes.plot_settings('default')
```

```{python}
script_dir = xarpes.set_script_dir()

dfld = 'data_sets'  # Folder containing the data
flnm = 'graphene_raw_101'  # Name of the file
extn = '.ibw'  # Extension of the file
tmpr = 80  # Data temperature [K]

# These three packages no longer have to be loaded once data is generated
# inside the band map class
import numpy as np 
from igor2 import binarywave
import os
data_file_path = os.path.join(script_dir, dfld, flnm + extn)
data = binarywave.load(data_file_path)

intn = data['wave']['wData']

fnum, anum = data['wave']['wave_header']['nDim'][0:2]

fstp, astp = data['wave']['wave_header']['sfA'][0:2]
fmin, amin = data['wave']['wave_header']['sfB'][0:2]

angl = np.linspace(amin, amin + (anum - 1) * astp, anum)
ekin = np.linspace(fmin, fmin + (fnum - 1) * fstp, fnum)
```

```{python}
import importlib
importlib.reload(xarpes)

fig = plt.figure(figsize=(6, 5))
ax = fig.gca()

bmap = xarpes.band_map(intensities=intn, angles=angl, ekin=ekin,
                       energy_resolution=0.01, angle_resolution=0.1,
                       temperature=80)

fig = bmap.fit_fermi_edge(hnuminphi_guess=32, background_guess=1e5,
                          integrated_weight_guess=1.5e6, angle_min=-10,
                          angle_max=10, ekin_min=31.9, ekin_max=32.1,
                          ax=ax, show=True,
                          title='Fermi edge fit')

print('The optimised h nu - phi=' + f'{bmap.hnuminphi:.4f}' + ' +/- '
      + f'{bmap.hnuminphi_std:.4f}' + ' eV.')
```

```{python}
fig = bmap.plot()
```

```{python}
angle_min = 0
angle_max = 1e6
en_val = 32.0107
energy_range = [31.9, 32.1]

mdcs = xarpes.MDCs(*bmap.slicing(angle_min, angle_max, energy_value=en_val))

fig = plt.figure(figsize=(6, 5))
ax = fig.gca()

fig = mdcs.plot(ax=ax, show=False)
```

```{python}
import importlib
importlib.reload(xarpes)

angle_min = 0
angle_max = 1e6
en_val = 32.0107

mdcs = xarpes.MDCs(*bmap.slicing(angle_min, angle_max, energy_value=en_val))
new_range = mdcs.angles

fig = plt.figure(figsize=(6, 5))
ax = fig.gca()

line1 = xarpes.spectral_linear(amplitude=500, peak=7.5, broadening=0.01, name="Linear test", index="1")
line2 = xarpes.spectral_linear(amplitude=600, peak=5.5, broadening=0.02, name="Linear test", index="2")

line1.plot(angle_range=new_range, angle_resolution=0.1, ax=ax, show=False)
line2.plot(angle_range=new_range, angle_resolution=0.1, ax=ax, show=False)
fig = mdcs.plot(ax=ax)
```

```{python}
dist_list = xarpes.distribution_list([
xarpes.linear(offset=2.2e3, slope=-65),
xarpes.spectral_linear(amplitude=450, peak=7.4, broadening=0.012, name='Linear_test', index='1'),
# xarpes.spectral_linear(amplitude=60, peak=4.2, broadening=0.018, name='Linear_test', index='2'),
xarpes.spectral_quadratic(amplitude=20, peak=5.5, center_wavevector=0, broadening=0.005, 
                         side='right', name='Quadratic_test', index='1')
])

fig = mdcs.initial_guess(distribution_list=dist_list())
```

```{python}
dist_list = xarpes.distribution_list([
xarpes.linear(offset=2.2e3, slope=-65),
xarpes.spectral_linear(amplitude=450, peak=7.4, broadening=0.012, name='Linear_test', index='1'),
# xarpes.spectral_linear(amplitude=60, peak=4.2, broadening=0.018, name='Linear_test', index='2'),
xarpes.spectral_quadratic(amplitude=20, peak=4.5, center_wavevector=0, broadening=0.005, 
                         side='right', name='Quadratic_test', index='1')
])


mat_el = lambda x, scal, brew, **kwargs: scal * x + brew
mat_args = {
    'scal' : 0.03,
    'brew' : 1.0,
}

fig = mdcs.initial_guess(distribution_list=dist_list(), matrix_element=mat_el, matrix_args=mat_args)

new_distributions, new_mat_args, covariance_matrix = mdcs.fit(distribution_list=dist_list(),
                                    matrix_element=mat_el, matrix_args=mat_args)

fig = mdcs.initial_guess(distribution_list=new_distributions, matrix_element=mat_el, matrix_args=new_mat_args)
```

```{python}
change = xarpes.spectral_linear(amplitude=500, peak=7.5, broadening=0.01, name="Linear_test", index="1")

change.broadening = 0.02

print(change.broadening)
```

```{python}
add = lambda x: np.sin(x)**2

import numpy as np
xrange = np.linspace(-np.pi/2, np.pi/2, 100)

plt.plot(xrange, add(xrange))
```

```{python}

```
